# Direttiva 07.03 â€” Dashboard UI Screen

**Obiettivo:** Riscrivere la schermata Dashboard (attualmente placeholder) con FideLux Score, alert banner, KPI cards, tasso documentazione, e top 5 categorie. Supporto pull-to-refresh, loading, ed empty state.

**CriticitÃ :** ðŸŸ¢ BASSO â€” Solo UI, nessuna logica di business.

**Prerequisiti:** Direttive 07.01 + 07.02 completate. Provider `dashboardDataProvider` funzionante.

**Dipendenze:** 07.02 (providers + l10n)

---

## Input

- `directives/07-dashboard.md` Step 4 (UI Dashboard Screen)
- `brand-guidelines.md` sezione 5.4 (FideLux Score Widget)
- `brand-guidelines.md` sezione 5.5 (Toast/Alert Banner)
- `lib/theme/` â€” spacing, radius, colori
- `lib/presentation/providers/dashboard_providers.dart` (da 07.02)

## Output Atteso

1. `lib/presentation/screens/dashboard/dashboard_screen.dart` â€” riscrittura completa
2. `flutter analyze` clean
3. La schermata si apre, mostra loading, poi dati (o empty state)
4. Design conforme a brand-guidelines

---

## Step 1 â€” Struttura della Schermata

Sostituire il contenuto di `lib/presentation/screens/dashboard/dashboard_screen.dart`:

```dart
class DashboardScreen extends ConsumerWidget {
  const DashboardScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dashboardAsync = ref.watch(dashboardDataProvider);

    return dashboardAsync.when(
      loading: () => _buildLoading(context),
      error: (e, _) => _buildError(context, e),
      data: (data) => _buildDashboard(context, ref, data),
    );
  }
}
```

<rules>
1. **ScrollView verticale** (`RefreshIndicator` + `SingleChildScrollView` + `Column`):
   - Pull-to-refresh: `ref.invalidate(dashboardDataProvider)` nel `onRefresh`

2. **FideLux Score Card** (in alto, prominente)
   - `Card` con `color: FideLuxColors.scoreBackground` (Color(0xFFFFF8E1))
   - Numero grande al centro: `Theme.of(context).textTheme.displayMedium`, bold
   - Colore numero: condizionale su `scoreLevel`:
     - `ScoreLevel.high` â†’ `FideLuxColors.scoreHigh` (Color(0xFF43A047))
     - `ScoreLevel.medium` â†’ `FideLuxColors.scoreMedium` (Color(0xFFF57C00))
     - `ScoreLevel.low` â†’ `FideLuxColors.scoreLow` (Color(0xFFD32F2F))
   - Label sotto il numero: `l10n.dashboardScoreHigh` / `Medium` / `Low`
   - Freccia trend a destra del numero:
     - `ScoreTrend.up` â†’ "â–²" verde (scoreHigh)
     - `ScoreTrend.down` â†’ "â–¼" rosso (scoreLow)
     - `ScoreTrend.stable` â†’ "â–º" neutro (onSurfaceVariant)
   - Progress bar sotto: `LinearProgressIndicator` con `value: score/100`, colore del livello, height 8px, `borderRadius: FideLuxRadius.full`
   - Padding: `FideLuxSpacing.s4` (16px) intorno

3. **Alert Banner** (solo se `activeAlerts` non Ã¨ vuoto)
   - Ogni alert Ã¨ una `Card` con bordo sinistro colorato (4px):
     - `AlertLevel.advisory` â†’ `Color(0xFFF57C00)` (orange)
     - `AlertLevel.critical` â†’ `Color(0xFFD32F2F)` (red)
     - `AlertLevel.sos` â†’ `Color(0xFFB71C1C)` (red.900)
   - Layout: `Row` â†’ icona (warning/error) + `Column` â†’ titolo + descrizione
   - Icona:
     - advisory â†’ `Icons.info_outline`, colore orange
     - critical â†’ `Icons.warning_amber`, colore red
     - sos â†’ `Icons.sos`, colore red.900
   - Titolo: `l10n.alertAdvisory` / `alertCritical` / `alertSos` â€” bold
   - Descrizione: usa il `descriptionKey` dell'alert con i parametri. Serve un helper per risolvere la chiave l10n dinamicamente.
   - Mostra max 3 alert. Se ce ne sono di piÃ¹: testo "Mostra altri N" (`l10n.dashboardShowMoreAlerts`)
   - Solo gli alert `advisory` possono essere dismissati (trailing IconButton "X"). Critical e SOS non dismissabili.
   - Non mostrare alert con `dismissed == true`

4. **KPI Row** (2Ã—2 griglia)
   - Usa `GridView.count(crossAxisCount: 2, shrinkWrap: true, physics: NeverScrollableScrollPhysics())`
   - 4 Card:
     - "Saldo Totale" â†’ `l10n.dashboardTotalBalance`, icona `Icons.account_balance`, importo formattato con `CurrencyFormatter`
     - "Spese Mese" â†’ `l10n.dashboardMonthExpenses`, icona `Icons.trending_down`, colore `Theme.of(context).colorScheme.error`, importo negativo
     - "Entrate Mese" â†’ `l10n.dashboardMonthIncome`, icona `Icons.trending_up`, colore verde
     - "Transazioni" â†’ `l10n.dashboardTransactions`, icona `Icons.receipt_long`, conteggio (non centesimi)
   - Ogni card: `Card(elevation: 1)`, `borderRadius: FideLuxRadius.md` (12px), padding `FideLuxSpacing.s4`

5. **Tasso Documentazione** (sezione propria)
   - Titolo: `l10n.dashboardDocumentationRate`
   - Sotto-titolo: `l10n.dashboardDocumentationDays(documented, total)` es. "26/31 giorni"
   - `LinearProgressIndicator` con `value: documentationRate`
   - Colore barra:
     - rate > 0.7 â†’ scoreHigh (verde)
     - rate > 0.4 â†’ scoreMedium (amber)
     - rate â‰¤ 0.4 â†’ scoreLow (rosso)

6. **Spese per Categoria** (top 5)
   - Header: `l10n.dashboardTopCategories` + `TextButton` "Vedi tutte" â†’ navigazione a Reports tab
   - Lista delle top 5 categorie per importo (ordinate decrescente):
     - `Row` â†’ icona categoria (da `TransactionCategory.icon`) + nome + `Expanded` barra proporzionale + importo
     - La barra piÃ¹ lunga = 100% dello spazio disponibile, le altre proporzionali
     - Implementare con `FractionallySizedBox` o `Container` con width calcolata
     - Colori: `TransactionCategory.color` per ogni barra
   - Se meno di 5 categorie, mostrare quelle disponibili
   - "Vedi tutte" â†’ `GoRouter.of(context).go('/reports')` o cambia tab index

7. **Loading state**: `CircularProgressIndicator` centrato nella schermata

8. **Empty state** (se `transactionCount == 0`):
   - Icona grande `Icons.dashboard_outlined`, tono soft
   - Testo: `l10n.dashboardNoData`
   - Nessun KPI, nessun alert â€” solo il messaggio

9. **Spacing tra sezioni**: `SizedBox(height: FideLuxSpacing.s4)` (16px)
</rules>

---

## Step 2 â€” Helper per Alert Description

L'`ActiveAlert` usa chiavi l10n dinamiche (`descriptionKey` + `descriptionParams`). Serve un helper per risolvere la stringa:

```dart
String _resolveAlertDescription(L l10n, ActiveAlert alert) {
  switch (alert.descriptionKey) {
    case 'alertCategorySpike':
      return l10n.alertCategorySpike(
        alert.descriptionParams['category'] ?? '',
        alert.descriptionParams['percent'] ?? '',
      );
    case 'alertNoDocumentation':
      return l10n.alertNoDocumentation(
        alert.descriptionParams['days'] ?? '',
      );
    case 'alertMultipleCashWithdrawals':
      return l10n.alertMultipleCashWithdrawals(
        alert.descriptionParams['count'] ?? '',
      );
    case 'alertGamblingDetected':
      return l10n.alertGamblingDetected;
    case 'alertSosReceived':
      return l10n.alertSosReceived;
    default:
      return alert.descriptionKey; // Fallback
  }
}
```

<rules>
1. Questo helper vive nello stesso file della schermata (funzione privata `_resolveAlertDescription`).
2. Funziona perchÃ© le chiavi degli alert sono stabili e mappate 1:1 ai metodi generati da `flutter gen-l10n`.
3. Se l10n non ha il getter, ritorna la chiave grezza come fallback.
</rules>

---

## Step 3 â€” Import e dipendenze

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:fidelux/l10n/generated/app_localizations.dart';
import 'package:fidelux/presentation/providers/dashboard_providers.dart';
import 'package:fidelux/domain/entities/dashboard_data.dart';
import 'package:fidelux/domain/entities/transaction_category.dart';
import 'package:fidelux/core/utils/currency_formatter.dart';
import 'package:fidelux/theme/fidelux_spacing.dart';
import 'package:fidelux/theme/fidelux_radius.dart';
```

<rules>
1. La schermata Ã¨ un `ConsumerWidget` (Riverpod).
2. Nessuna libreria esterna per grafici â€” solo Widget Flutter standard.
3. I colori score/alert possono essere inline (`Color(0xFF...)`) o estratti in costanti nel file del tema se non giÃ  presenti. Verificare se `FideLuxColors` esiste in `lib/theme/`. Se no, definire costanti locali nel file.
4. Usare `CurrencyFormatter` per formattare gli importi in centesimi â†’ stringa euro.
5. Non creare widget separati in file diversi â€” tutto in un unico file per la dashboard.
</rules>

---

## Validazione

```bash
flutter analyze
flutter run    # Verificare visivamente la schermata
```

Checklist:
- [ ] FideLux Score card visibile con numero, colore, trend, progress bar
- [ ] Alert banner mostra alert con colore bordo corretto
- [ ] Max 3 alert visibili + "Mostra altri"
- [ ] Advisory dismissabili, critical/sos non dismissabili
- [ ] KPI cards 2Ã—2 con saldo, spese, entrate, transazioni
- [ ] Importi formattati con `CurrencyFormatter` (â‚¬ con 2 decimali)
- [ ] Tasso documentazione con barra colorata
- [ ] Top 5 categorie con barre proporzionali e icone
- [ ] Pull-to-refresh funziona
- [ ] Loading state con spinner
- [ ] Empty state se nessuna transazione
- [ ] Spacing e radius conformi a brand-guidelines
- [ ] `flutter analyze` clean

---

## Prossimo Modulo

â†’ `directives/07.04-reports-ui.md` (Report screen con grafici CustomPainter)

**Nota:** 07.03 e 07.04 possono essere implementate in parallelo se lo sviluppatore lo desidera, poichÃ© condividono solo i providers (giÃ  creati nella 07.02) e non hanno dipendenze reciproche.
