# Direttiva 07.05 â€” Navigation Badge + Validazione Finale

**Obiettivo:** Aggiungere il badge alert critici sulla tab Dashboard nella navigazione, eseguire la validazione completa (`flutter analyze` + `flutter test`), e verificare la checklist MVP.

**CriticitÃ :** ðŸŸ¢ BASSO â€” Modifiche minime, validazione end-to-end.

**Prerequisiti:** Direttive 07.01 + 07.02 + 07.03 + 07.04 completate.

**Dipendenze:** 07.03 e 07.04 (le schermate UI devono compilare)

---

## Input

- `directives/07-dashboard.md` Step 6 (Navigation Badge)
- `lib/presentation/shell/main_shell.dart` â€” file esistente da modificare
- `lib/presentation/providers/dashboard_providers.dart` â€” `criticalAlertCountProvider`

## Output Atteso

1. `lib/presentation/shell/main_shell.dart` â€” badge su tab Dashboard
2. `flutter analyze` clean (zero warning, zero error)
3. `flutter test` green (tutti i test passano, inclusi 07.01 e 07.04)
4. Checklist MVP completa

---

## Step 1 â€” Badge su Tab Dashboard

### Modifica `lib/presentation/shell/main_shell.dart`

Trasformare `MainShell` da `StatelessWidget` a `ConsumerWidget` per accedere a Riverpod:

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:fidelux/l10n/generated/app_localizations.dart';
import 'package:fidelux/presentation/providers/dashboard_providers.dart';

class MainShell extends ConsumerWidget {
  const MainShell({super.key, required this.navigationShell});

  final StatefulNavigationShell navigationShell;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final l10n = L.of(context)!;
    final criticalAlertCount = ref.watch(criticalAlertCountProvider);

    return Scaffold(
      body: SafeArea(child: navigationShell),
      bottomNavigationBar: NavigationBar(
        selectedIndex: navigationShell.currentIndex,
        onDestinationSelected: (index) {
          navigationShell.goBranch(
            index,
            initialLocation: index == navigationShell.currentIndex,
          );
        },
        destinations: [
          NavigationDestination(
            icon: const Icon(Icons.mail_outline),
            selectedIcon: const Icon(Icons.mail),
            label: l10n.tabInbox,
          ),
          NavigationDestination(
            icon: Badge(
              isLabelVisible: criticalAlertCount > 0,
              label: Text(criticalAlertCount.toString()),
              child: const Icon(Icons.dashboard_outlined),
            ),
            selectedIcon: Badge(
              isLabelVisible: criticalAlertCount > 0,
              label: Text(criticalAlertCount.toString()),
              child: const Icon(Icons.dashboard),
            ),
            label: l10n.tabDashboard,
          ),
          NavigationDestination(
            icon: const Icon(Icons.receipt_long_outlined),
            selectedIcon: const Icon(Icons.receipt_long),
            label: l10n.tabLedger,
          ),
          NavigationDestination(
            icon: const Icon(Icons.bar_chart_outlined),
            selectedIcon: const Icon(Icons.bar_chart),
            label: l10n.tabReports,
          ),
          NavigationDestination(
            icon: const Icon(Icons.settings_outlined),
            selectedIcon: const Icon(Icons.settings),
            label: l10n.tabSettings,
          ),
        ],
      ),
    );
  }
}
```

<rules>
1. **`StatelessWidget` â†’ `ConsumerWidget`**: necessario per `ref.watch`.
2. **`Badge` widget** (Material 3, nativo Flutter): mostra il conteggio alert critici.
3. `isLabelVisible: criticalAlertCount > 0` â€” nasconde il badge se non ci sono alert critici.
4. Il badge appare sia sull'icona non selezionata che su quella selezionata.
5. **Solo alert `critical` e `sos` non dismissati** attivano il badge (logica giÃ  in `criticalAlertCountProvider`).
6. Non aggiungere badge su altre tab in questa sotto-direttiva.
7. Se `criticalAlertCountProvider` restituisce 0 (nessun alert), la navigazione appare identica a prima.
</rules>

---

## Step 2 â€” Validazione Completa

### 2.1 Analisi statica

```bash
flutter analyze
```

**Zero errori e zero warning richiesti.** Errori comuni da verificare:
- Import mancanti (nuovi file non importati)
- Tipi non matching (es. `int` vs `double` per score)
- Parametri `required` mancanti nei costruttori delle entitÃ 
- Getter l10n non generati (eseguire `flutter gen-l10n` se necessario)
- Unused imports (rimuoverli)

### 2.2 Test suite completa

```bash
flutter test
```

**Tutti i test devono passare**, inclusi:
- `test/crypto/` â€” test preesistenti (non devono regredire)
- `test/chain/` â€” test preesistenti
- `test/integration/` â€” test preesistenti
- `test/ai/` â€” test direttiva 06
- `test/dashboard/dashboard_service_test.dart` â€” 8 test da 07.01
- `test/reports/report_data_test.dart` â€” 3 test da 07.04

### 2.3 Esecuzione app

```bash
flutter run
```

Verificare manualmente:
- L'app si avvia senza crash
- La navigazione tra tutte e 5 le tab funziona
- Dashboard mostra dati (o empty state se nessun dato)
- Report mostra grafici (o empty state)

---

## Step 3 â€” Checklist MVP Finale

Questa Ã¨ la checklist completa dalla direttiva 07 originale. Tutti i punti devono essere soddisfatti:

- [ ] Dashboard mostra FideLux Score con colore e trend corretto
- [ ] KPI cards con saldo, spese, entrate, transazioni
- [ ] Tasso documentazione con barra di progresso colorata
- [ ] Top 5 categorie con barre proporzionali e icone
- [ ] Alert banner visibile se presenti alert (advisory/critical)
- [ ] Report mostra grafico donut spese per categoria
- [ ] Report mostra trend giornaliero a barre
- [ ] Selettore periodo (Mese/Trimestre/Anno) funziona e cambia i dati
- [ ] Pull-to-refresh su dashboard
- [ ] Empty state corretto se nessun dato
- [ ] Badge su tab Dashboard per alert critici
- [ ] `flutter analyze` clean
- [ ] `flutter test` green (tutti 11+ test)

---

## ðŸŽ‰ MVP Completato

Con questa sotto-direttiva, tutte le funzionalitÃ  MVP sono implementate:

| Modulo | Direttiva | FunzionalitÃ  |
|--------|-----------|--------------|
| 01 | Project Setup | Struttura, tema, localizzazione, navigation |
| 02 | Crypto Chain | Ed25519, SHA-256, catena append-only |
| 03 | Pairing | QR code, scambio chiavi, handshake |
| 04 | Email Channel | IMAP/SMTP, messaggi firmati, validazione |
| 05 | Accounting Core | Conti, transazioni, database SQLite, ledger UI |
| 06 | OCR Receipts | ML Kit, parsing scontrini, pre-compilazione form |
| 07.01 | Domain + Service | EntitÃ , repository, score, alert, DAO queries |
| 07.02 | Use Cases + L10n | Use cases, providers, localizzazione EN/IT |
| 07.03 | Dashboard UI | Score card, KPI, alert banner, categorie |
| 07.04 | Reports UI | Donut chart, bar chart, confronto mensile |
| 07.05 | Badge + Validazione | Navigation badge, test completi, checklist |

**Prossimi passi (V1.0 â€” directives future):**
- Integrazione LLM on-device (Gemma 3n) per parsing intelligente scontrini
- Gemini OAuth come fallback
- FideLux Score completo (5 componenti pesati)
- Upload e parsing estratto conto mensile
- Meccanismo SOS completo con cooling-off
- Weekly digest email automatico
