# Direttiva 07.04 â€” Report UI Screen con Grafici CustomPainter

**Obiettivo:** Riscrivere la schermata Report (attualmente placeholder) con grafico donut per categorie, bar chart trend giornaliero, confronto mensile, top esercenti, e selettore periodo. Include 3 test per la logica dei dati report.

**CriticitÃ :** ðŸŸ¢ BASSO â€” UI + CustomPainter. Nessuna logica di business nuova.

**Prerequisiti:** Direttive 07.01 + 07.02 completate. Provider `reportDataProvider` funzionante.

**Dipendenze:** 07.02 (providers + l10n). PuÃ² essere implementata in parallelo con 07.03.

---

## Input

- `directives/07-dashboard.md` Step 5 (UI Report Screen)
- `brand-guidelines.md` â€” palette colori, spacing, radius
- `lib/presentation/providers/report_providers.dart` (da 07.02)
- `lib/domain/entities/report_data.dart` (da 07.01)

## Output Atteso

1. `lib/presentation/screens/reports/reports_screen.dart` â€” riscrittura completa
2. `test/reports/report_data_test.dart` â€” 3 test
3. `flutter analyze` clean
4. `flutter test test/reports/` green

---

## Step 1 â€” Struttura della Schermata

Sostituire il contenuto di `lib/presentation/screens/reports/reports_screen.dart`:

```dart
class ReportsScreen extends ConsumerWidget {
  const ReportsScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final l10n = L.of(context)!;
    final reportAsync = ref.watch(reportDataProvider);
    final selectedPeriod = ref.watch(selectedPeriodProvider);

    return Scaffold(
      appBar: AppBar(
        title: Text(l10n.reportsTitle),
      ),
      body: Column(
        children: [
          // Period selector chips
          _buildPeriodSelector(context, ref, selectedPeriod, l10n),
          // Report content
          Expanded(
            child: reportAsync.when(
              loading: () => const Center(child: CircularProgressIndicator()),
              error: (e, _) => Center(child: Text(e.toString())),
              data: (data) => _buildReport(context, data, l10n),
            ),
          ),
        ],
      ),
    );
  }
}
```

<rules>
1. **AppBar** con titolo `l10n.reportsTitle`

2. **Selettore Periodo** (sotto l'AppBar, fuori dallo scroll)
   - `Row` centrata con 3 `ChoiceChip`:
     - `l10n.reportsPeriodMonth` (default selezionato)
     - `l10n.reportsPeriodQuarter`
     - `l10n.reportsPeriodYear`
   - Tap cambia `ref.read(selectedPeriodProvider.notifier).state = period`
   - Padding: `FideLuxSpacing.s3` (12px) orizzontale, `FideLuxSpacing.s2` (8px) verticale

3. **Contenuto scrollabile** (`SingleChildScrollView` + `Column`):

4. **Grafico Donut â€” Spese per Categoria** (`_DonutChartWidget`)
   - Header: `l10n.reportsCategoryBreakdown`
   - `CustomPainter` che disegna un anello (donut) con archi proporzionali
   - Dimensione: 200Ã—200, spessore anello: 30px
   - Al centro del donut: totale spese formattato (â‚¬)
   - Colori: `TransactionCategory.color` per ogni spicchio
   - Sotto il grafico: legenda verticale
     - Ogni riga: cerchio colorato 12Ã—12 + nome categoria + importo + percentuale
   - Se nessuna spesa: mostra cerchio grigio con testo "Nessun dato"

5. **Grafico a Barre â€” Trend Giornaliero** (`_BarChartWidget`)
   - Header: `l10n.reportsDailyTrend`
   - `CustomPainter` che disegna barre verticali
   - Asse X: giorni (1, 5, 10, 15, 20, 25, 30 come label)
   - Asse Y: importo in euro (auto-scale, 4-5 label)
   - Barre: colore `Theme.of(context).colorScheme.error` (rosso per spese)
   - Altezza max barra = valore max giornaliero
   - Se il mese ha >15 giorni: il grafico Ã¨ alto 200px, scrollabile orizzontalmente con `SingleChildScrollView(scrollDirection: Axis.horizontal)`
   - Larghezza barra: 8px, gap: 4px

6. **Confronto Mensile**
   - Header: `l10n.reportsMonthlyComparison`
   - Se `monthlyComparison` ha meno di 2 mesi: mostra `l10n.reportsInsufficientData`
   - Altrimenti: `Row` di card (max 3):
     - Ogni card: nome mese (localizzato), totale spese, totale entrate
     - Freccia variazione % rispetto al mese precedente (se disponibile):
       - In aumento â†’ icona â–² rosso (spese aumentate = negativo)
       - In diminuzione â†’ icona â–¼ verde (spese diminuite = positivo)

7. **Top Esercenti**
   - Header: `l10n.reportsTopMerchants`
   - Lista top 5 `MerchantTotal`:
     - `ListTile`: leading `CircleAvatar` con iniziale del merchant, title = nome merchant, subtitle = `l10n.reportsTransactions(count)`, trailing = importo formattato
   - Se lista vuota: testo "Nessun esercente trovato"

8. **Export Placeholder**
   - `FilledButton.tonal` disabilitato con testo `l10n.reportsExportComingSoon`
   - Centrato, padding `FideLuxSpacing.s4`

9. **Dati insufficienti state** (se `totalExpenses == 0`):
   - Icona `Icons.bar_chart_outlined` grande
   - Testo `l10n.reportsInsufficientData`
</rules>

---

## Step 2 â€” Donut Chart CustomPainter

```dart
class _DonutChartPainter extends CustomPainter {
  final Map<TransactionCategory, int> categoryBreakdown;
  final int totalExpenses;

  _DonutChartPainter({required this.categoryBreakdown, required this.totalExpenses});

  @override
  void paint(Canvas canvas, Size size) {
    final center = Offset(size.width / 2, size.height / 2);
    final radius = size.width / 2 - 15; // margine
    const strokeWidth = 30.0;

    final rect = Rect.fromCircle(center: center, radius: radius);

    if (totalExpenses == 0) {
      // Cerchio grigio placeholder
      final paint = Paint()
        ..color = Colors.grey.shade300
        ..style = PaintingStyle.stroke
        ..strokeWidth = strokeWidth;
      canvas.drawArc(rect, 0, 2 * pi, false, paint);
      return;
    }

    double startAngle = -pi / 2; // Parte da ore 12

    for (final entry in categoryBreakdown.entries) {
      final sweepAngle = (entry.value / totalExpenses) * 2 * pi;
      final paint = Paint()
        ..color = entry.key.color
        ..style = PaintingStyle.stroke
        ..strokeWidth = strokeWidth
        ..strokeCap = StrokeCap.butt;
      canvas.drawArc(rect, startAngle, sweepAngle, false, paint);
      startAngle += sweepAngle;
    }
  }

  @override
  bool shouldRepaint(covariant _DonutChartPainter oldDelegate) {
    return oldDelegate.categoryBreakdown != categoryBreakdown;
  }
}
```

<rules>
1. Il donut parte da -Ï€/2 (ore 12) e procede in senso orario.
2. `strokeWidth = 30.0` per un anello visivamente equilibrato in un cerchio 200Ã—200.
3. I segmenti con valore < 1% del totale possono essere accorpati in "Altro" per evitare archi invisibili.
4. `shouldRepaint` confronta i dati per evitare ridisegni inutili.
5. Il totale al centro NON Ã¨ disegnato dal CustomPainter â€” Ã¨ un `Text` widget sovrapposto con uno `Stack`.
6. Import necessario: `dart:math` per `pi`.
</rules>

---

## Step 3 â€” Bar Chart CustomPainter

```dart
class _BarChartPainter extends CustomPainter {
  final Map<DateTime, int> dailyTotals;
  final int maxValue;

  _BarChartPainter({required this.dailyTotals, required this.maxValue});

  @override
  void paint(Canvas canvas, Size size) {
    if (dailyTotals.isEmpty || maxValue == 0) return;

    const barWidth = 8.0;
    const gap = 4.0;
    const bottomPadding = 20.0; // Per label asse X
    const leftPadding = 40.0;   // Per label asse Y

    final chartHeight = size.height - bottomPadding;
    final chartWidth = size.width - leftPadding;

    // Disegna asse Y (4 linee guida orizzontali)
    _drawYAxis(canvas, size, chartHeight, leftPadding);

    // Disegna barre
    final sortedDays = dailyTotals.keys.toList()..sort();

    for (int i = 0; i < sortedDays.length; i++) {
      final day = sortedDays[i];
      final value = dailyTotals[day]!.abs(); // Centesimi, positivo
      final barHeight = (value / maxValue) * chartHeight;

      final x = leftPadding + i * (barWidth + gap);
      final y = chartHeight - barHeight;

      final paint = Paint()..color = Colors.red.shade400;
      canvas.drawRRect(
        RRect.fromRectAndCorners(
          Rect.fromLTWH(x, y, barWidth, barHeight),
          topLeft: const Radius.circular(2),
          topRight: const Radius.circular(2),
        ),
        paint,
      );

      // Label giorno sotto la barra (ogni 5 giorni)
      if (day.day % 5 == 1 || day.day == 1) {
        _drawDayLabel(canvas, x + barWidth / 2, chartHeight + 4, day.day);
      }
    }
  }

  @override
  bool shouldRepaint(covariant _BarChartPainter oldDelegate) {
    return oldDelegate.dailyTotals != dailyTotals;
  }
}
```

<rules>
1. Le barre rappresentano spese giornaliere (valore assoluto dei centesimi).
2. Il `maxValue` Ã¨ calcolato dal widget padre: `dailyTotals.values.map((v) => v.abs()).reduce(max)`.
3. La larghezza totale del grafico dipende dal numero di giorni. Se >15 giorni, il widget padre lo wrappa in un `SingleChildScrollView(scrollDirection: Axis.horizontal)` con un `SizedBox(width: sortedDays.length * 12.0 + 40)`.
4. Le label asse Y mostrano valori in euro (centesimi / 100), formattati senza decimali se > â‚¬10.
5. Le label asse X mostrano il giorno del mese ogni 5 posizioni.
6. Il colore delle barre usa `Theme.of(context).colorScheme.error` â€” ma dentro `CustomPainter` non c'Ã¨ accesso al tema. Passare il colore come parametro del painter.
</rules>

---

## Step 4 â€” Test

### test/reports/report_data_test.dart

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:drift/native.dart';
import 'package:fidelux/data/local_db/app_database.dart';
import 'package:fidelux/data/local_db/daos/transactions_dao.dart';
import 'package:fidelux/data/local_db/daos/accounts_dao.dart';
import 'package:fidelux/data/dashboard/dashboard_service.dart';
import 'package:fidelux/domain/entities/report_data.dart';
import 'package:fidelux/domain/entities/transaction_category.dart';

void main() {
  late AppDatabase db;
  late TransactionsDao txDao;
  late AccountsDao accDao;
  late DashboardService service;

  setUp(() {
    db = AppDatabase.forTesting(NativeDatabase.memory());
    txDao = TransactionsDao(db);
    accDao = AccountsDao(db);
    service = DashboardService(txDao, accDao);
  });

  tearDown(() async => await db.close());

  // Helper per inserire account + chain event + transazioni
  // (stesso pattern dei test 07.01)
}
```

**3 test richiesti:**

```
1. "calculates category breakdown correctly"
   Setup: 3 transazioni groceries (-5000), 2 dining (-3000), 1 transport (-1000)
   Expected: categoryBreakdown[groceries] == 5000, [dining] == 3000, [transport] == 1000
   (valori positivi â€” il servizio fa .abs())

2. "calculates daily totals"
   Setup: transazioni su 3 giorni diversi con importi noti
   Expected: dailyTotals mappa contiene i 3 giorni con i totali corretti

3. "handles empty month gracefully"
   Setup: account senza transazioni, DateRange del mese corrente
   Expected: categoryBreakdown vuoto, dailyTotals vuoto, totalExpenses == 0, no crash
```

<rules>
1. Stessa struttura setUp/tearDown dei test 07.01.
2. Inserire chain event fittizio + account prima delle transazioni (foreign key).
3. Date nel mese corrente per allinearsi con `DateRange.currentMonth()`.
4. Verificare sia i totali categoria che i totali giornalieri.
5. Il test "empty month" Ã¨ critico â€” il CustomPainter deve gestire dati vuoti senza crash.
</rules>

---

## Validazione

```bash
flutter analyze
flutter test test/reports/
flutter run    # Verificare visivamente la schermata
```

Checklist:
- [ ] Grafico donut visibile con spicchi colorati per categoria
- [ ] Legenda sotto il donut con colore + nome + importo + %
- [ ] Totale spese al centro del donut
- [ ] Bar chart con barre giornaliere rosse
- [ ] Scrollabile orizzontalmente se >15 giorni
- [ ] Asse Y con label euro, asse X con giorni
- [ ] Selettore periodo (Mese/Trimestre/Anno) cambia i dati
- [ ] Confronto mensile con card e frecce variazione
- [ ] Top 5 esercenti con iniziale, nome, conteggio, importo
- [ ] Export button disabilitato con testo "Coming Soon"
- [ ] Empty state se nessun dato
- [ ] 3/3 test passano
- [ ] `flutter analyze` clean

---

## Prossimo Modulo

â†’ `directives/07.05-badge-validation.md` (Navigation badge + validazione finale)
